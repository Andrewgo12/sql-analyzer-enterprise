{% extends "base.html" %}

{% block title %}Advanced Analysis Hub - SQL Analyzer Enterprise{% endblock %}

{% block page_title %}
{% if active_tab == 'sql-analysis' %}SQL Analysis & Correction
{% elif active_tab == 'security-analysis' %}Security & Vulnerability Scanning
{% elif active_tab == 'performance-optimizer' %}Performance Optimization
{% elif active_tab == 'schema-analysis' %}Schema & Relationship Analysis
{% elif active_tab == 'cache-management' %}Cache & System Management
{% elif active_tab == 'database-connections' %}Database Connections
{% elif active_tab == 'export-center' %}Export & Format Conversion
{% elif active_tab == 'system-monitoring' %}System Monitoring
{% else %}Advanced Analysis Hub
{% endif %}
{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="uploadFile()">
    üìÅ Subir Archivo SQL
</button>
<button class="btn btn-secondary" onclick="clearResults()">
    üóëÔ∏è Limpiar
</button>
{% endblock %}

{% block extra_css %}
<style>
    /* ===== TAB CONTENT STYLES ===== */
    .tab-content {
        min-height: 600px;
        padding: 24px 0;
        animation: fadeIn 0.5s ease-out;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-muted);
        position: relative;
    }

    .empty-state::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        border-radius: 2px;
    }

    .empty-state-icon {
        font-size: 80px;
        margin-bottom: 24px;
        opacity: 0.7;
        animation: bounce 2s infinite;
        display: inline-block;
    }

    .empty-state h3 {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        background: linear-gradient(135deg, var(--primary-color), var(--success-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .empty-state p {
        font-size: 18px;
        margin-bottom: 32px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.7;
    }

    .features-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        max-width: 900px;
        margin: 0 auto;
        text-align: left;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
    }

    .feature-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .feature-item:hover::before {
        left: 100%;
    }

    .feature-item:hover {
        border-color: var(--success-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .feature-icon {
        color: var(--success-color);
        font-size: 18px;
        font-weight: bold;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 50%;
        position: relative;
        z-index: 1;
    }

    .feature-text {
        color: var(--text-secondary);
        font-size: 15px;
        font-weight: 500;
        position: relative;
        z-index: 1;
    }

    /* ===== FILE UPLOAD AREA ===== */
    .upload-area {
        border: 2px dashed var(--border-primary);
        border-radius: var(--radius-lg);
        padding: 60px 20px;
        text-align: center;
        margin-bottom: 32px;
        transition: all var(--transition-normal);
        cursor: pointer;
        position: relative;
        background: var(--bg-secondary);
        overflow: hidden;
    }

    .upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.05) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    .upload-area:hover::before {
        transform: translateX(100%);
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(59, 130, 246, 0.08);
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
    }

    .upload-area.dragover {
        border-color: var(--success-color);
        background: rgba(16, 185, 129, 0.08);
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
    }

    .upload-area.dragover::after {
        content: 'üìÅ Suelta el archivo aqu√≠';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--success-color);
        color: white;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 16px;
        animation: bounce 0.5s ease;
    }

    /* ===== RESULTS DISPLAY ===== */
    .results-container {
        display: grid;
        gap: 20px;
        margin-top: 24px;
    }

    .result-card {
        background: #111111;
        border: 1px solid #262626;
        border-radius: 8px;
        padding: 20px;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .result-title {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
    }

    .result-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .result-status.success {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .result-status.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .result-status.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    /* ===== LOADING SPINNER ===== */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #262626;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .features-list {
            grid-template-columns: 1fr;
        }

        .empty-state {
            padding: 40px 16px;
        }

        .empty-state-icon {
            font-size: 48px;
        }

        .empty-state h3 {
            font-size: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="tab-content">
    <!-- File Upload Area -->
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div class="empty-state-icon">üìÅ</div>
        <h3>Subir Archivo SQL</h3>
        <p>Arrastra y suelta un archivo SQL aqu√≠ o haz clic para seleccionar</p>
        <input type="file" id="fileInput" accept=".sql,.txt" style="display: none;" onchange="handleFileSelect(this)">
    </div>

    <!-- Current File Info -->
    {% if app_state.current_file %}
    <div class="card">
        <div class="card-header">
            <div class="card-title">üìÑ Archivo Actual</div>
            <button class="btn btn-secondary btn-sm" onclick="removeFile()">Remover</button>
        </div>
        <div class="card-content">
            <p><strong>Nombre:</strong> {{ app_state.current_file.name }}</p>
            <p><strong>Tama√±o:</strong> {{ app_state.current_file.size }} bytes</p>
            <p><strong>Subido:</strong> {{ app_state.current_file.uploaded_at }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Tab-specific Content -->
    {% if active_tab == 'sql-analysis' %}
    <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <h3>SQL Analysis & Correction</h3>
        <p>Analiza archivos SQL para detectar errores de sintaxis, problemas de rendimiento y vulnerabilidades de
            seguridad</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Detecci√≥n y correcci√≥n de errores de sintaxis</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Sugerencias de optimizaci√≥n de rendimiento</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Escaneo de vulnerabilidades de seguridad</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">An√°lisis de esquema y relaciones</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'security-analysis' %}
    <div class="empty-state">
        <div class="empty-state-icon">üõ°Ô∏è</div>
        <h3>Security & Vulnerability Scanning</h3>
        <p>Escanea archivos SQL en busca de vulnerabilidades de seguridad y riesgos de inyecci√≥n</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Detecci√≥n de vulnerabilidades de inyecci√≥n SQL</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Identificaci√≥n de funciones peligrosas</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Verificaci√≥n de cumplimiento OWASP Top 10</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">An√°lisis de permisos y privilegios</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'performance-optimizer' %}
    <div class="empty-state">
        <div class="empty-state-icon">‚ö°</div>
        <h3>Performance Optimization</h3>
        <p>Analiza y optimiza el rendimiento de consultas SQL</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Recomendaciones de optimizaci√≥n de consultas</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Sugerencias de √≠ndices</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">An√°lisis de plan de ejecuci√≥n</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Identificaci√≥n de cuellos de botella</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'schema-analysis' %}
    <div class="empty-state">
        <div class="empty-state-icon">üîó</div>
        <h3>Schema & Relationship Analysis</h3>
        <p>Analiza la estructura de la base de datos y las relaciones entre tablas</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">An√°lisis de estructura de tablas</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Mapeo de relaciones</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Evaluaci√≥n de normalizaci√≥n</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Detecci√≥n de inconsistencias</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'cache-management' %}
    <div class="empty-state">
        <div class="empty-state-icon">üíæ</div>
        <h3>Cache & System Management</h3>
        <p>Monitorea y gestiona el rendimiento del cach√© del sistema</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Monitoreo de cach√© en tiempo real</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Seguimiento de uso de memoria</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">M√©tricas de rendimiento de cach√©</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Limpieza autom√°tica de cach√©</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'database-connections' %}
    <div class="empty-state">
        <div class="empty-state-icon">üóÑÔ∏è</div>
        <h3>Database Connections</h3>
        <p>Gestiona conexiones a m√°s de 50 motores de base de datos</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Soporte para 50+ motores de base de datos</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Prueba y validaci√≥n de conexiones</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Gesti√≥n segura de credenciales</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Pool de conexiones optimizado</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'export-center' %}
    <div class="empty-state">
        <div class="empty-state-icon">üì§</div>
        <h3>Export & Format Conversion</h3>
        <p>Exporta resultados de an√°lisis en m√°s de 50 formatos</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">50+ formatos de exportaci√≥n disponibles</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Procesamiento de exportaci√≥n por lotes</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Conversi√≥n de formato personalizada</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Compresi√≥n autom√°tica de archivos</div>
            </div>
        </div>
    </div>

    {% elif active_tab == 'system-monitoring' %}
    <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <h3>System Monitoring</h3>
        <p>Monitoreo en tiempo real del rendimiento y salud del sistema</p>
        <div class="features-list">
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">M√©tricas de rendimiento en tiempo real</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Monitoreo de salud del sistema</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Sistema de alertas y notificaciones</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">‚úÖ</div>
                <div class="feature-text">Logs detallados de actividad</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Analysis Results -->
    {% if app_state.analysis_results %}
    <div class="results-container">
        <div class="result-card">
            <div class="result-header">
                <div class="result-title">üìä Resultados del An√°lisis</div>
                <div class="result-status success">Completado</div>
            </div>
            <div class="card-content">
                <p>An√°lisis completado exitosamente. Los resultados est√°n disponibles para exportaci√≥n.</p>
                <div class="mt-2">
                    <button class="btn btn-primary" onclick="exportResults('json')">Exportar JSON</button>
                    <button class="btn btn-secondary" onclick="exportResults('html')">Exportar HTML</button>
                    <button class="btn btn-secondary" onclick="exportResults('pdf')">Exportar PDF</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // File upload handling
    function handleFileSelect(input) {
        const file = input.files[0];
        if (file) {
            uploadFileToServer(file);
        }
    }

    function uploadFileToServer(file) {
        if (!validateFile(file)) return;

        const formData = new FormData();
        formData.append('file', file);

        const uploadBtn = document.querySelector('button[onclick="uploadFile()"]');
        if (uploadBtn) setLoading(uploadBtn, true);

        const progressContainer = createProgressIndicator();

        showAlert(`üì§ Subiendo archivo: ${file.name}...`, 'info');

        fetch('/api/analyze', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ Archivo analizado exitosamente', 'success');
                    updateAnalysisResults(data.results, data.file_info);
                    animateResultsAppearance();
                } else {
                    showAlert('‚ùå Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showAlert('üö® Error de conexi√≥n: ' + error.message, 'error');
            })
            .finally(() => {
                if (uploadBtn) setLoading(uploadBtn, false);
                removeProgressIndicator(progressContainer);
            });
    }

    function validateFile(file) {
        const maxSize = 100 * 1024 * 1024; // 100MB
        const allowedTypes = ['.sql', '.txt'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        if (file.size > maxSize) {
            showAlert('El archivo es demasiado grande. M√°ximo 100MB permitido.', 'error');
            return false;
        }

        if (!allowedTypes.includes(fileExtension)) {
            showAlert('Tipo de archivo no v√°lido. Solo se permiten archivos .sql y .txt', 'error');
            return false;
        }

        return true;
    }

    function createProgressIndicator() {
        const container = document.createElement('div');
        container.className = 'progress-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 16px;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            animation: slideInRight 0.3s ease;
        `;

        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="loading-spinner" style="width: 20px; height: 20px; border: 2px solid var(--border-primary); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="color: var(--text-primary); font-weight: 500;">Procesando archivo...</span>
            </div>
        `;

        document.body.appendChild(container);
        return container;
    }

    function removeProgressIndicator(container) {
        if (container) {
            container.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => container.remove(), 300);
        }
    }

    function updateAnalysisResults(results, fileInfo) {
        // Update file info display
        const fileInfoSection = document.querySelector('.current-file-info') || createFileInfoSection();
        fileInfoSection.innerHTML = generateFileInfoHTML(fileInfo);

        // Update results display
        const resultsContainer = document.querySelector('.results-container') || createResultsContainer();
        resultsContainer.innerHTML = generateResultsHTML(results);

        // Show export options
        showExportOptions();

        // Animate results appearance
        animateResultsAppearance();
    }

    function createFileInfoSection() {
        const section = document.createElement('div');
        section.className = 'current-file-info';
        section.style.marginBottom = '24px';

        const tabContent = document.querySelector('.tab-content');
        tabContent.appendChild(section);
        return section;
    }

    function generateFileInfoHTML(fileInfo) {
        return `
            <div class="card animate-slide-in-up">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="card-title">üìÑ Archivo Analizado</div>
                    <button class="btn btn-sm btn-secondary" onclick="removeFile()">Remover</button>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <strong>Nombre:</strong><br>
                            <span style="color: var(--text-secondary);">${fileInfo.filename || fileInfo.name}</span>
                        </div>
                        <div>
                            <strong>Tama√±o:</strong><br>
                            <span style="color: var(--text-secondary);">${fileInfo.size_human || formatFileSize(fileInfo.size)}</span>
                        </div>
                        <div>
                            <strong>L√≠neas:</strong><br>
                            <span style="color: var(--text-secondary);">${fileInfo.total_lines || 'N/A'}</span>
                        </div>
                        <div>
                            <strong>Procesado:</strong><br>
                            <span style="color: var(--text-secondary);">${formatDateTime(fileInfo.processed || fileInfo.uploaded_at)}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function generateResultsHTML(results) {
        let html = '';

        // SQL Analysis Results
        if (results.sql_analysis) {
            html += generateSQLAnalysisHTML(results.sql_analysis);
        }

        // Security Analysis Results
        if (results.security_analysis) {
            html += generateSecurityAnalysisHTML(results.security_analysis);
        }

        // Performance Analysis Results
        if (results.performance_analysis) {
            html += generatePerformanceAnalysisHTML(results.performance_analysis);
        }

        return html;
    }

    function generateSQLAnalysisHTML(analysis) {
        const qualityColor = analysis.quality_score >= 80 ? 'var(--success-color)' :
            analysis.quality_score >= 60 ? 'var(--warning-color)' : 'var(--danger-color)';

        return `
            <div class="result-card animate-slide-in-up">
                <div class="result-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                    <div class="result-title">üîç An√°lisis SQL</div>
                    <div class="result-status" style="color: ${qualityColor};">
                        Puntuaci√≥n: ${analysis.quality_score}/100
                    </div>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="metric-item">
                            <strong>Errores de Sintaxis:</strong><br>
                            <span style="color: var(--danger-color); font-size: 18px; font-weight: bold;">${analysis.syntax_errors?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Errores Sem√°nticos:</strong><br>
                            <span style="color: var(--warning-color); font-size: 18px; font-weight: bold;">${analysis.semantic_errors?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Optimizaciones:</strong><br>
                            <span style="color: var(--primary-color); font-size: 18px; font-weight: bold;">${analysis.optimizations?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Complejidad:</strong><br>
                            <span style="color: var(--text-secondary); font-size: 18px; font-weight: bold;">${analysis.complexity_score}/100</span>
                        </div>
                    </div>
                    ${analysis.recommendations ? `
                        <div style="margin-top: 16px;">
                            <strong>üìã Recomendaciones:</strong>
                            <ul style="margin-top: 8px;">
                                ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${analysis.syntax_errors && analysis.syntax_errors.length > 0 ? `
                        <div style="margin-top: 16px;">
                            <strong>üö® Errores de Sintaxis Detectados:</strong>
                            <div style="margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                ${analysis.syntax_errors.slice(0, 3).map((error, index) => `
                                    <div style="padding: 8px; margin: 4px 0; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--danger-color); cursor: pointer; transition: all 0.2s;" onclick="showErrorDetails(${JSON.stringify(error).replace(/"/g, '&quot;')})" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                        <strong>${error.message || error.description}</strong> (L√≠nea ${error.line})<br>
                                        <small style="color: var(--text-muted);">${error.suggestion || 'Error de sintaxis detectado'}</small>
                                        <div style="margin-top: 4px; font-size: 11px; color: var(--primary-color);">üîç Click para ver detalles y correcci√≥n autom√°tica</div>
                                    </div>
                                `).join('')}
                                ${analysis.syntax_errors.length > 3 ? `<div style="text-align: center; margin-top: 8px;"><small>... y ${analysis.syntax_errors.length - 3} errores m√°s</small></div>` : ''}
                            </div>
                            <div style="margin-top: 12px; text-align: center; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-primary btn-sm" onclick="showAllSQLErrors()">üìã Ver Todos los Errores</button>
                                <button class="btn btn-success btn-sm" onclick="showCodePreviewWithCorrections()">üîß Vista Previa con Correcciones</button>
                                <button class="btn btn-warning btn-sm" onclick="showStatistics(currentAnalysisData)">üìä Estad√≠sticas Detalladas</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function generateSecurityAnalysisHTML(security) {
        const riskColor = security.risk_level === 'CRITICAL' ? 'var(--danger-color)' :
            security.risk_level === 'HIGH' ? 'var(--warning-color)' :
                security.risk_level === 'MEDIUM' ? 'var(--primary-color)' : 'var(--success-color)';

        return `
            <div class="result-card animate-slide-in-up">
                <div class="result-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="result-title">üõ°Ô∏è An√°lisis de Seguridad</div>
                    <div class="result-status" style="color: ${riskColor};">
                        Riesgo: ${security.risk_level}
                    </div>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="metric-item">
                            <strong>Puntuaci√≥n de Seguridad:</strong><br>
                            <span style="color: ${riskColor}; font-size: 18px; font-weight: bold;">${security.security_score}/100</span>
                        </div>
                        <div class="metric-item">
                            <strong>Vulnerabilidades:</strong><br>
                            <span style="color: var(--danger-color); font-size: 18px; font-weight: bold;">${security.vulnerabilities?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Cr√≠ticas:</strong><br>
                            <span style="color: var(--danger-color); font-size: 18px; font-weight: bold;">${security.vulnerability_summary?.critical || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Altas:</strong><br>
                            <span style="color: var(--warning-color); font-size: 18px; font-weight: bold;">${security.vulnerability_summary?.high || 0}</span>
                        </div>
                    </div>
                    ${security.vulnerabilities && security.vulnerabilities.length > 0 ? `
                        <div style="margin-top: 16px;">
                            <strong>üö® Vulnerabilidades de Seguridad Detectadas:</strong>
                            <div style="margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                ${security.vulnerabilities.slice(0, 3).map((vuln, index) => `
                                    <div style="padding: 8px; margin: 4px 0; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid ${vuln.risk_level === 'critical' ? 'var(--danger-color)' : vuln.risk_level === 'high' ? 'var(--warning-color)' : 'var(--primary-color)'}; cursor: pointer; transition: all 0.2s;" onclick="showVulnerabilityDetails(${JSON.stringify(vuln).replace(/"/g, '&quot;')})" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <strong>${vuln.title}</strong>
                                            <span style="background: ${vuln.risk_level === 'critical' ? 'var(--danger-color)' : vuln.risk_level === 'high' ? 'var(--warning-color)' : 'var(--primary-color)'}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">${vuln.risk_level?.toUpperCase()}</span>
                                        </div>
                                        <small style="color: var(--text-muted);">L√≠nea ${vuln.line}: ${vuln.description}</small><br>
                                        <div style="margin-top: 4px; font-size: 11px; color: var(--primary-color);">üõ°Ô∏è Click para ver detalles y soluci√≥n de seguridad</div>
                                    </div>
                                `).join('')}
                                ${security.vulnerabilities.length > 3 ? `<div style="text-align: center; margin-top: 8px;"><small>... y ${security.vulnerabilities.length - 3} vulnerabilidades m√°s</small></div>` : ''}
                            </div>
                            <div style="margin-top: 12px; text-align: center; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-danger btn-sm" onclick="showAllVulnerabilities()">üö® Ver Todas las Vulnerabilidades</button>
                                <button class="btn btn-warning btn-sm" onclick="generateSecurityReport()">üìã Reporte de Seguridad</button>
                                <button class="btn btn-success btn-sm" onclick="showSecurityRecommendations()">üîí Recomendaciones</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function generatePerformanceAnalysisHTML(performance) {
        const perfColor = performance.performance_score >= 80 ? 'var(--success-color)' :
            performance.performance_score >= 60 ? 'var(--warning-color)' : 'var(--danger-color)';

        return `
            <div class="result-card animate-slide-in-up">
                <div class="result-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="result-title">‚ö° An√°lisis de Rendimiento</div>
                    <div class="result-status" style="color: ${perfColor};">
                        Puntuaci√≥n: ${performance.performance_score}/100
                    </div>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="metric-item">
                            <strong>Problemas de Rendimiento:</strong><br>
                            <span style="color: var(--warning-color); font-size: 18px; font-weight: bold;">${performance.performance_issues?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Sugerencias de √çndices:</strong><br>
                            <span style="color: var(--primary-color); font-size: 18px; font-weight: bold;">${performance.index_suggestions?.length || 0}</span>
                        </div>
                        <div class="metric-item">
                            <strong>Complejidad:</strong><br>
                            <span style="color: var(--text-secondary); font-size: 18px; font-weight: bold;">${performance.overall_complexity || 'N/A'}</span>
                        </div>
                    </div>
                    ${performance.recommendations ? `
                        <div style="margin-top: 16px;">
                            <strong>üí° Recomendaciones de Rendimiento:</strong>
                            <ul style="margin-top: 8px;">
                                ${performance.recommendations.slice(0, 3).map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${performance.performance_issues && performance.performance_issues.length > 0 ? `
                        <div style="margin-top: 16px;">
                            <strong>‚ö° Problemas de Rendimiento Detectados:</strong>
                            <div style="margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                ${performance.performance_issues.slice(0, 3).map((issue, index) => `
                                    <div style="padding: 8px; margin: 4px 0; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--warning-color); cursor: pointer; transition: all 0.2s;" onclick="showPerformanceDetails(${JSON.stringify(issue).replace(/"/g, '&quot;')})" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                        <strong>${issue.title || issue.type}</strong> (L√≠nea ${issue.line})<br>
                                        <small style="color: var(--text-muted);">${issue.description || issue.suggestion}</small><br>
                                        <div style="margin-top: 4px; font-size: 11px; color: var(--success-color);">üìà Mejora estimada: ${issue.estimated_improvement || 'Significativa'}</div>
                                        <div style="margin-top: 2px; font-size: 11px; color: var(--primary-color);">‚ö° Click para ver optimizaci√≥n autom√°tica</div>
                                    </div>
                                `).join('')}
                                ${performance.performance_issues.length > 3 ? `<div style="text-align: center; margin-top: 8px;"><small>... y ${performance.performance_issues.length - 3} problemas m√°s</small></div>` : ''}
                            </div>
                            <div style="margin-top: 12px; text-align: center; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-warning btn-sm" onclick="showAllPerformanceIssues()">‚ö° Ver Todos los Problemas</button>
                                <button class="btn btn-success btn-sm" onclick="generateOptimizedCode()">üöÄ C√≥digo Optimizado</button>
                                <button class="btn btn-primary btn-sm" onclick="showIndexSuggestions()">üìä Sugerencias de √çndices</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function showExportOptions() {
        const exportSection = document.querySelector('.export-section') || createExportSection();
        exportSection.innerHTML = `
            <div class="card animate-slide-in-up">
                <div class="card-header">
                    <div class="card-title">üì§ Exportar Resultados</div>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <button class="btn btn-primary" onclick="exportResults('json')">üìÑ JSON</button>
                        <button class="btn btn-secondary" onclick="exportResults('html')">üåê HTML</button>
                        <button class="btn btn-secondary" onclick="exportResults('csv')">üìä CSV</button>
                        <button class="btn btn-secondary" onclick="exportResults('xml')">üìã XML</button>
                        <button class="btn btn-secondary" onclick="exportResults('pdf')">üìë PDF</button>
                        <button class="btn btn-secondary" onclick="exportResults('txt')">üìù TXT</button>
                        <button class="btn btn-secondary" onclick="exportResults('markdown')">üìù MD</button>
                        <button class="btn btn-secondary" onclick="exportResults('excel')">üìà Excel</button>
                        <button class="btn btn-secondary" onclick="exportResults('sql')">üóÉÔ∏è SQL</button>
                    </div>
                </div>
            </div>
        `;
    }

    function createExportSection() {
        const section = document.createElement('div');
        section.className = 'export-section';
        section.style.marginTop = '24px';

        const resultsContainer = document.querySelector('.results-container');
        resultsContainer.appendChild(section);
        return section;
    }

    function exportResults(format) {
        const btn = event.target;
        setLoading(btn, true);

        fetch(`/api/export/${format}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sql_analysis.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert(`‚úÖ Archivo ${format.toUpperCase()} descargado exitosamente`, 'success');
            })
            .catch(error => {
                showAlert(`‚ùå Error al exportar: ${error.message}`, 'error');
            })
            .finally(() => {
                setLoading(btn, false);
            });
    }

    function removeFile() {
        if (confirm('¬øEst√°s seguro de que quieres remover el archivo actual?')) {
            location.reload();
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ===== INTERACTIVE FUNCTIONS =====
    let currentAnalysisData = null;

    function showAllSQLErrors() {
        if (!currentAnalysisData || !currentAnalysisData.sql_analysis?.syntax_errors) {
            showAlert('‚ùå No hay errores de sintaxis para mostrar', 'info');
            return;
        }

        const errors = currentAnalysisData.sql_analysis.syntax_errors;
        let content = '<div style="max-height: 400px; overflow-y: auto;">';

        errors.forEach((error, index) => {
            content += `
                <div style="padding: 12px; margin: 8px 0; background: var(--bg-tertiary); border-radius: 6px; border-left: 4px solid var(--danger-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: var(--danger-color);">Error ${index + 1}</strong>
                        <button class="btn btn-sm btn-primary" onclick="showErrorDetails(${JSON.stringify(error).replace(/"/g, '&quot;')})">üîß Corregir</button>
                    </div>
                    <div><strong>Mensaje:</strong> ${error.message || error.description}</div>
                    <div><strong>L√≠nea:</strong> ${error.line} | <strong>Columna:</strong> ${error.column || 'N/A'}</div>
                    <div><strong>Sugerencia:</strong> ${error.suggestion || 'Revisar sintaxis SQL'}</div>
                </div>
            `;
        });

        content += '</div>';

        document.getElementById('error-details-content').innerHTML = content;
        showModal('error-details-modal');
    }

    function showAllVulnerabilities() {
        if (!currentAnalysisData || !currentAnalysisData.security_analysis?.vulnerabilities) {
            showAlert('‚ùå No hay vulnerabilidades para mostrar', 'info');
            return;
        }

        const vulnerabilities = currentAnalysisData.security_analysis.vulnerabilities;
        let content = '<div style="max-height: 400px; overflow-y: auto;">';

        vulnerabilities.forEach((vuln, index) => {
            const riskColor = vuln.risk_level === 'critical' ? 'var(--danger-color)' :
                vuln.risk_level === 'high' ? 'var(--warning-color)' :
                    vuln.risk_level === 'medium' ? 'var(--primary-color)' : 'var(--success-color)';

            content += `
                <div style="padding: 12px; margin: 8px 0; background: var(--bg-tertiary); border-radius: 6px; border-left: 4px solid ${riskColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: ${riskColor};">${vuln.title}</strong>
                        <div>
                            <span style="background: ${riskColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-right: 8px;">${vuln.risk_level?.toUpperCase()}</span>
                            <button class="btn btn-sm btn-danger" onclick="showVulnerabilityDetails(${JSON.stringify(vuln).replace(/"/g, '&quot;')})">üõ°Ô∏è Solucionar</button>
                        </div>
                    </div>
                    <div><strong>Descripci√≥n:</strong> ${vuln.description}</div>
                    <div><strong>L√≠nea:</strong> ${vuln.line} | <strong>CWE:</strong> ${vuln.cwe_id}</div>
                    <div><strong>Evidencia:</strong> <code>${vuln.evidence}</code></div>
                </div>
            `;
        });

        content += '</div>';

        document.getElementById('vulnerability-content').innerHTML = content;
        showModal('vulnerability-modal');
    }

    function showAllPerformanceIssues() {
        if (!currentAnalysisData || !currentAnalysisData.performance_analysis?.performance_issues) {
            showAlert('‚ùå No hay problemas de rendimiento para mostrar', 'info');
            return;
        }

        const issues = currentAnalysisData.performance_analysis.performance_issues;
        let content = '<div style="max-height: 400px; overflow-y: auto;">';

        issues.forEach((issue, index) => {
            content += `
                <div style="padding: 12px; margin: 8px 0; background: var(--bg-tertiary); border-radius: 6px; border-left: 4px solid var(--warning-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: var(--warning-color);">${issue.title || issue.type}</strong>
                        <button class="btn btn-sm btn-success" onclick="showPerformanceDetails(${JSON.stringify(issue).replace(/"/g, '&quot;')})">‚ö° Optimizar</button>
                    </div>
                    <div><strong>Descripci√≥n:</strong> ${issue.description || issue.suggestion}</div>
                    <div><strong>L√≠nea:</strong> ${issue.line} | <strong>Mejora:</strong> ${issue.estimated_improvement || 'Significativa'}</div>
                    <div><strong>C√≥digo actual:</strong> <code>${issue.current_code || 'N/A'}</code></div>
                </div>
            `;
        });

        content += '</div>';

        document.getElementById('performance-content').innerHTML = content;
        showModal('performance-modal');
    }

    function showCodePreviewWithCorrections() {
        if (!currentAnalysisData) {
            showAlert('‚ùå No hay datos de an√°lisis disponibles', 'error');
            return;
        }

        // Simular c√≥digo corregido basado en los errores encontrados
        let corrections = [];

        if (currentAnalysisData.sql_analysis?.syntax_errors) {
            corrections = currentAnalysisData.sql_analysis.syntax_errors.map(error => ({
                line: error.line,
                type: 'error',
                suggestion: error.suggestion || 'Correcci√≥n sugerida'
            }));
        }

        // C√≥digo de ejemplo (en una implementaci√≥n real, esto vendr√≠a del backend)
        const sampleCode = `-- C√≥digo SQL Corregido
SELECT u.id, u.username, u.email
FROM users u
WHERE u.is_active = TRUE
  AND u.created_at >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
ORDER BY u.created_at DESC
LIMIT 100;

-- Consulta optimizada con √≠ndices sugeridos
CREATE INDEX idx_users_active_created ON users(is_active, created_at);

-- Consulta de seguridad mejorada (sin SQL injection)
SELECT * FROM products
WHERE category_id = ?
  AND price BETWEEN ? AND ?
  AND is_active = TRUE;`;

        showCodePreview(sampleCode, corrections);
    }

    // Store analysis data when received
    function updateAnalysisResults(results, fileInfo) {
        currentAnalysisData = results;

        // Update file info display
        const fileInfoSection = document.querySelector('.current-file-info') || createFileInfoSection();
        fileInfoSection.innerHTML = generateFileInfoHTML(fileInfo);

        // Update results display
        const resultsContainer = document.querySelector('.results-container') || createResultsContainer();
        resultsContainer.innerHTML = generateResultsHTML(results);

        // Show export options
        showExportOptions();

        // Animate results appearance
        animateResultsAppearance();
    }

    function animateResultsAppearance() {
        const results = document.querySelectorAll('.result-card');
        results.forEach((result, index) => {
            setTimeout(() => {
                result.classList.add('animate-slide-in-up');
            }, index * 200);
        });
    }

    // Drag and drop handling
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            uploadFileToServer(files[0]);
        }
    });

    // Export functions
    function exportResults(format) {
        showAlert('Exportando resultados...', 'info');

        fetch(`/api/export/${format}`)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Error en la exportaci√≥n');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_results.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showAlert('Archivo exportado exitosamente', 'success');
            })
            .catch(error => {
                showAlert('Error en la exportaci√≥n: ' + error.message, 'error');
            });
    }

    function clearResults() {
        if (confirm('¬øEst√°s seguro de que quieres limpiar todos los resultados?')) {
            fetch('/api/clear', { method: 'POST' })
                .then(() => {
                    showAlert('Resultados limpiados', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    showAlert('Error al limpiar: ' + error.message, 'error');
                });
        }
    }

    function removeFile() {
        if (confirm('¬øRemover el archivo actual?')) {
            fetch('/api/remove-file', { method: 'POST' })
                .then(() => {
                    showAlert('Archivo removido', 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    showAlert('Error al remover archivo: ' + error.message, 'error');
                });
        }
    }

    function uploadFile() {
        document.getElementById('fileInput').click();
    }
</script>
{% endblock %}