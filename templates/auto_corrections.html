{% extends "base.html" %}

{% block title %}Correcciones Autom√°ticas - SQL Analyzer Enterprise{% endblock %}
{% block page_title %}üîß Correcciones Autom√°ticas{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="applyAllCorrections()">‚úÖ Aplicar Todas</button>
<button class="btn btn-success" onclick="downloadCorrectedSQL()">üíæ Descargar SQL Corregido</button>
{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Auto-Corrections Dashboard -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">üîß Sistema de Correcciones Autom√°ticas</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <div style="width: 8px; height: 8px; background: var(--success-color); border-radius: 50%; animation: pulse 2s infinite;"></div>
                <span style="font-size: 12px; color: var(--success-color);">ACTIVO</span>
            </div>
        </div>
        <div class="card-content">
            <!-- Correction Summary -->
            <div class="stats-grid" style="margin-bottom: 32px;">
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--danger-color);">85</div>
                    <div class="stat-label">Errores Detectados</div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">üö® Requieren correcci√≥n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success-color);">78</div>
                    <div class="stat-label">Auto-Corregibles</div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">üîß Correcci√≥n autom√°tica</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--warning-color);">7</div>
                    <div class="stat-label">Revisi√≥n Manual</div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">üë§ Requiere intervenci√≥n</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--primary-color);">92%</div>
                    <div class="stat-label">Tasa de √âxito</div>
                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">üìä Correcciones exitosas</div>
                </div>
            </div>

            <!-- Correction Categories -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                <div>
                    <h4 style="margin-bottom: 16px; color: var(--text-primary);">üîß Correcciones Autom√°ticas Disponibles</h4>
                    <div id="auto-corrections" style="max-height: 400px; overflow-y: auto;">
                        <div class="correction-item auto" onclick="showCorrectionDetails('missing-semicolon')">
                            <div class="correction-header">
                                <div class="correction-type">Missing Semicolon</div>
                                <div class="correction-count">47 ocurrencias</div>
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); applyCorrection('missing-semicolon')">üîß Aplicar</button>
                            </div>
                            <div class="correction-description">Agregar punto y coma al final de declaraciones SQL</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå SELECT * FROM users</div>
                                <div class="code-after">‚úÖ SELECT * FROM users;</div>
                            </div>
                        </div>

                        <div class="correction-item auto" onclick="showCorrectionDetails('keyword-case')">
                            <div class="correction-header">
                                <div class="correction-type">Keyword Case Standardization</div>
                                <div class="correction-count">23 ocurrencias</div>
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); applyCorrection('keyword-case')">üîß Aplicar</button>
                            </div>
                            <div class="correction-description">Estandarizar palabras clave SQL a may√∫sculas</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå select * from users where id = 1</div>
                                <div class="code-after">‚úÖ SELECT * FROM users WHERE id = 1;</div>
                            </div>
                        </div>

                        <div class="correction-item auto" onclick="showCorrectionDetails('quotes-standardization')">
                            <div class="correction-header">
                                <div class="correction-type">Quote Standardization</div>
                                <div class="correction-count">15 ocurrencias</div>
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); applyCorrection('quotes-standardization')">üîß Aplicar</button>
                            </div>
                            <div class="correction-description">Estandarizar comillas simples para strings</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå WHERE name = "John"</div>
                                <div class="code-after">‚úÖ WHERE name = 'John'</div>
                            </div>
                        </div>

                        <div class="correction-item auto" onclick="showCorrectionDetails('table-aliases')">
                            <div class="correction-header">
                                <div class="correction-type">Table Alias Optimization</div>
                                <div class="correction-count">12 ocurrencias</div>
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); applyCorrection('table-aliases')">üîß Aplicar</button>
                            </div>
                            <div class="correction-description">Agregar aliases a tablas para mejor legibilidad</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå SELECT users.name FROM users</div>
                                <div class="code-after">‚úÖ SELECT u.name FROM users u</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 style="margin-bottom: 16px; color: var(--text-primary);">üë§ Correcciones que Requieren Revisi√≥n Manual</h4>
                    <div id="manual-corrections" style="max-height: 400px; overflow-y: auto;">
                        <div class="correction-item manual" onclick="showCorrectionDetails('complex-join')">
                            <div class="correction-header">
                                <div class="correction-type">Complex JOIN Optimization</div>
                                <div class="correction-count">3 ocurrencias</div>
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); reviewCorrection('complex-join')">üëÅÔ∏è Revisar</button>
                            </div>
                            <div class="correction-description">Optimizaci√≥n de JOINs complejos requiere revisi√≥n</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå Consulta con m√∫ltiples JOINs anidados</div>
                                <div class="code-after">‚ö†Ô∏è Requiere an√°lisis manual</div>
                            </div>
                        </div>

                        <div class="correction-item manual" onclick="showCorrectionDetails('business-logic')">
                            <div class="correction-header">
                                <div class="correction-type">Business Logic Validation</div>
                                <div class="correction-count">2 ocurrencias</div>
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); reviewCorrection('business-logic')">üëÅÔ∏è Revisar</button>
                            </div>
                            <div class="correction-description">Validaci√≥n de l√≥gica de negocio espec√≠fica</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå Condiciones de negocio complejas</div>
                                <div class="code-after">‚ö†Ô∏è Requiere validaci√≥n manual</div>
                            </div>
                        </div>

                        <div class="correction-item manual" onclick="showCorrectionDetails('data-type-conversion')">
                            <div class="correction-header">
                                <div class="correction-type">Data Type Conversion</div>
                                <div class="correction-count">2 ocurrencias</div>
                                <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); reviewCorrection('data-type-conversion')">üëÅÔ∏è Revisar</button>
                            </div>
                            <div class="correction-description">Conversiones de tipo de datos requieren validaci√≥n</div>
                            <div class="correction-preview">
                                <div class="code-before">‚ùå Conversiones impl√≠citas detectadas</div>
                                <div class="code-after">‚ö†Ô∏è Verificar compatibilidad</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Correction Progress -->
            <div style="margin-bottom: 32px;">
                <h4 style="margin-bottom: 16px; color: var(--text-primary);">üìä Progreso de Correcciones</h4>
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span>Correcciones Aplicadas</span>
                        <span style="font-weight: 600;">78 / 85 (92%)</span>
                    </div>
                    <div style="background: var(--bg-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--success-color), var(--primary-color)); height: 100%; width: 92%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                        <span>‚úÖ Auto-corregidas: 78</span>
                        <span>‚ö†Ô∏è Pendientes: 7</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="applyAllAutoCorrections()">üîß Aplicar Todas las Autom√°ticas</button>
                <button class="btn btn-primary" onclick="showCorrectedCode()">üëÅÔ∏è Vista Previa del C√≥digo</button>
                <button class="btn btn-warning" onclick="reviewManualCorrections()">üë§ Revisar Manuales</button>
                <button class="btn btn-secondary" onclick="exportCorrectionReport()">üìã Reporte de Correcciones</button>
                <button class="btn btn-danger" onclick="resetCorrections()">üîÑ Reiniciar</button>
            </div>
        </div>
    </div>
</div>

<style>
.correction-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.correction-item:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.correction-item.auto {
    border-left: 4px solid var(--success-color);
}

.correction-item.manual {
    border-left: 4px solid var(--warning-color);
}

.correction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.correction-type {
    font-weight: 600;
    color: var(--text-primary);
}

.correction-count {
    font-size: 12px;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: 12px;
}

.correction-description {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 12px;
}

.correction-preview {
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 8px;
    font-family: monospace;
    font-size: 12px;
}

.code-before {
    color: var(--danger-color);
    margin-bottom: 4px;
}

.code-after {
    color: var(--success-color);
}
</style>

<script>
function showCorrectionDetails(type) {
    const details = {
        'missing-semicolon': {
            title: 'Missing Semicolon Correction',
            description: 'Automatically adds semicolons to SQL statements that are missing them.',
            examples: [
                { before: 'SELECT * FROM users', after: 'SELECT * FROM users;' },
                { before: 'INSERT INTO products VALUES (1, "Test")', after: 'INSERT INTO products VALUES (1, "Test");' }
            ]
        },
        'keyword-case': {
            title: 'Keyword Case Standardization',
            description: 'Converts all SQL keywords to uppercase for consistency.',
            examples: [
                { before: 'select * from users where id = 1', after: 'SELECT * FROM users WHERE id = 1' },
                { before: 'insert into products (name) values ("Test")', after: 'INSERT INTO products (name) VALUES ("Test")' }
            ]
        }
    };

    const detail = details[type] || { title: 'Correction Details', description: 'Detailed information about this correction.' };
    
    let content = `
        <div style="margin-bottom: 20px;">
            <h4>${detail.title}</h4>
            <p style="color: var(--text-secondary); margin-top: 8px;">${detail.description}</p>
        </div>
    `;

    if (detail.examples) {
        content += '<div style="margin-top: 16px;"><h5>Ejemplos:</h5>';
        detail.examples.forEach(example => {
            content += `
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin: 8px 0;">
                    <div style="color: var(--danger-color); font-family: monospace; margin-bottom: 4px;">‚ùå Antes: ${example.before}</div>
                    <div style="color: var(--success-color); font-family: monospace;">‚úÖ Despu√©s: ${example.after}</div>
                </div>
            `;
        });
        content += '</div>';
    }

    document.getElementById('error-details-content').innerHTML = content;
    showModal('error-details-modal');
}

function applyCorrection(type) {
    showAlert(`üîß Aplicando correcci√≥n: ${type}...`, 'info');
    
    setTimeout(() => {
        showAlert(`‚úÖ Correcci√≥n ${type} aplicada exitosamente`, 'success');
        // Update UI to reflect applied correction
        updateCorrectionProgress();
    }, 1500);
}

function reviewCorrection(type) {
    showAlert(`üëÅÔ∏è Abriendo revisi√≥n manual para: ${type}`, 'info');
    
    setTimeout(() => {
        const content = `
            <div style="margin-bottom: 20px;">
                <h4>üë§ Revisi√≥n Manual Requerida</h4>
                <p style="color: var(--text-secondary); margin-top: 8px;">
                    Esta correcci√≥n requiere revisi√≥n manual debido a su complejidad o impacto en la l√≥gica de negocio.
                </p>
            </div>
            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 16px 0;">
                <h5>C√≥digo Original:</h5>
                <pre style="background: var(--bg-secondary); padding: 12px; border-radius: 4px; margin: 8px 0; color: var(--danger-color);">SELECT u.*, o.*, p.*
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
LEFT JOIN order_items oi ON o.id = oi.order_id
LEFT JOIN products p ON oi.product_id = p.id
WHERE u.created_at > '2024-01-01'
  AND o.status = 'completed'
  AND p.is_active = TRUE;</pre>
                
                <h5>Sugerencia de Optimizaci√≥n:</h5>
                <pre style="background: var(--bg-secondary); padding: 12px; border-radius: 4px; margin: 8px 0; color: var(--success-color);">-- Optimizaci√≥n sugerida con √≠ndices espec√≠ficos
SELECT u.id, u.name, u.email,
       o.id as order_id, o.total_amount,
       p.id as product_id, p.name as product_name
FROM users u
INNER JOIN orders o ON u.id = o.user_id
INNER JOIN order_items oi ON o.id = oi.order_id
INNER JOIN products p ON oi.product_id = p.id
WHERE u.created_at > '2024-01-01'
  AND o.status = 'completed'
  AND p.is_active = TRUE
ORDER BY u.created_at DESC
LIMIT 1000;</pre>
            </div>
            <div style="margin-top: 16px;">
                <strong>‚ö†Ô∏è Consideraciones:</strong>
                <ul style="margin-top: 8px; color: var(--text-secondary);">
                    <li>Cambio de LEFT JOIN a INNER JOIN puede afectar resultados</li>
                    <li>Selecci√≥n espec√≠fica de columnas mejora rendimiento</li>
                    <li>LIMIT agregado para prevenir consultas masivas</li>
                    <li>ORDER BY puede requerir √≠ndice adicional</li>
                </ul>
            </div>
        `;
        
        document.getElementById('performance-content').innerHTML = content;
        showModal('performance-modal');
    }, 500);
}

function applyAllAutoCorrections() {
    if (confirm('¬øAplicar todas las correcciones autom√°ticas? Esta acci√≥n no se puede deshacer.')) {
        showAlert('üîß Aplicando todas las correcciones autom√°ticas...', 'info');
        
        setTimeout(() => {
            showAlert('‚úÖ Todas las correcciones autom√°ticas aplicadas exitosamente', 'success');
            updateCorrectionProgress();
        }, 3000);
    }
}

function showCorrectedCode() {
    const correctedCode = `-- C√ìDIGO SQL CORREGIDO AUTOM√ÅTICAMENTE
-- Correcciones aplicadas: 78/85

-- 1. Consulta de usuarios con correcciones aplicadas
SELECT u.id, u.username, u.email, u.created_at
FROM users u
WHERE u.is_active = TRUE
  AND u.created_at >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
ORDER BY u.created_at DESC
LIMIT 100;

-- 2. Consulta de productos optimizada
SELECT p.id, p.name, c.name AS category_name, p.price
FROM products p
INNER JOIN categories c ON p.category_id = c.id
WHERE p.is_active = TRUE
  AND p.price > 10.00
ORDER BY p.created_at DESC
LIMIT 50;

-- 3. Consulta agregada corregida
SELECT 
    DATE(o.created_at) AS order_date,
    COUNT(*) AS total_orders,
    SUM(o.total_amount) AS total_revenue
FROM orders o
WHERE o.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND o.status = 'completed'
GROUP BY DATE(o.created_at)
ORDER BY order_date DESC;

-- √çndices sugeridos para optimizaci√≥n:
CREATE INDEX idx_users_active_created ON users(is_active, created_at);
CREATE INDEX idx_products_active_price ON products(is_active, price, created_at);
CREATE INDEX idx_orders_status_created ON orders(status, created_at);`;

    showCodePreview(correctedCode, []);
}

function updateCorrectionProgress() {
    // Simulate progress update
    const progressBar = document.querySelector('[style*="width: 92%"]');
    if (progressBar) {
        progressBar.style.width = '95%';
    }
}

function reviewManualCorrections() {
    showAlert('üë§ Abriendo panel de revisi√≥n manual...', 'info');
    // Show manual review interface
}

function exportCorrectionReport() {
    showAlert('üìã Generando reporte de correcciones...', 'info');
    
    setTimeout(() => {
        const reportContent = `REPORTE DE CORRECCIONES AUTOM√ÅTICAS
========================================

RESUMEN:
- Total de errores detectados: 85
- Correcciones autom√°ticas aplicadas: 78
- Correcciones manuales pendientes: 7
- Tasa de √©xito: 92%

CORRECCIONES APLICADAS:
1. Missing Semicolon: 47 correcciones
2. Keyword Case Standardization: 23 correcciones  
3. Quote Standardization: 15 correcciones
4. Table Alias Optimization: 12 correcciones

CORRECCIONES PENDIENTES:
1. Complex JOIN Optimization: 3 casos
2. Business Logic Validation: 2 casos
3. Data Type Conversion: 2 casos

RECOMENDACIONES:
- Revisar manualmente las correcciones pendientes
- Implementar validaci√≥n autom√°tica en el pipeline
- Establecer est√°ndares de codificaci√≥n SQL

Generado: ${new Date().toLocaleString('es-ES')}
`;

        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'correction_report.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert('‚úÖ Reporte de correcciones descargado', 'success');
    }, 2000);
}

function resetCorrections() {
    if (confirm('¬øReiniciar todas las correcciones? Esto deshar√° todos los cambios aplicados.')) {
        showAlert('üîÑ Reiniciando correcciones...', 'warning');
        setTimeout(() => {
            showAlert('‚úÖ Correcciones reiniciadas', 'info');
            location.reload();
        }, 2000);
    }
}

function applyAllCorrections() {
    applyAllAutoCorrections();
}

function downloadCorrectedSQL() {
    showAlert('üíæ Preparando descarga del SQL corregido...', 'info');
    
    setTimeout(() => {
        showCorrectedCode();
    }, 1000);
}
</script>
{% endblock %}
