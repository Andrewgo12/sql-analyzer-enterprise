<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Analysis - SQL Analyzer Enterprise</title>

    <!-- CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="/static/css/main.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
            color: #000000;
            /* High contrast black text */
            line-height: 1.6;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .back-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .analysis-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .analysis-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 0.5rem;
                margin: 1rem auto;
            }

            .analysis-layout {
                gap: 1rem;
            }
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #000000;
            /* High contrast black */
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .upload-subtext {
            color: #333333;
            /* Dark gray for better contrast */
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .analysis-options {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            display: none;
        }

        .option-group {
            margin-bottom: 1.5rem;
        }

        .option-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-check {
            margin-bottom: 0.5rem;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            width: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced Interactive Elements */
        .btn,
        .form-control,
        .form-check-input,
        .form-range {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .card {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .form-range::-webkit-slider-thumb {
            background: #667eea;
            transition: all 0.3s ease;
        }

        .form-range::-webkit-slider-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .progress-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .download-btn {
            background: #48bb78;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        .download-btn:hover {
            background: #38a169;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-database me-2"></i>SQL Analyzer Enterprise
            </span>
            <a href="/" class="back-btn">
                <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- File Upload Section -->
        <div class="upload-section">
            <h2 class="mb-4">
                <i class="fas fa-upload me-2"></i>Subir Archivo SQL
            </h2>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    Arrastra y suelta tu archivo SQL aqu√≠
                </div>
                <div class="upload-subtext">
                    o haz clic para seleccionar (Soporta archivos .sql, .txt hasta 10GB)
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".sql,.txt" />
            </div>

            <div id="fileInfo" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="fileName"></span>
                    <span class="badge bg-secondary ms-2" id="fileSize"></span>
                </div>
            </div>
        </div>

        <!-- Analysis Options -->
        <div class="analysis-options" id="analysisOptions">
            <h3 class="mb-4">
                <i class="fas fa-cogs me-2"></i>Analysis Options
            </h3>

            <div class="row">
                <div class="col-md-6">
                    <div class="option-group">
                        <label class="option-label">Analysis Types</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="errorDetection" checked>
                            <label class="form-check-label" for="errorDetection">
                                Error Detection & Correction
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="codeCommenting" checked>
                            <label class="form-check-label" for="codeCommenting">
                                Intelligent Code Commenting
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="schemaAnalysis">
                            <label class="form-check-label" for="schemaAnalysis">
                                Schema Analysis
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="securityScan">
                            <label class="form-check-label" for="securityScan">
                                Security Vulnerability Scan
                            </label>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="option-group">
                        <label class="option-label">Download Format</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="downloadFormat" id="formatSQL"
                                value="sql" checked>
                            <label class="form-check-label" for="formatSQL">
                                Enhanced SQL File
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="downloadFormat" id="formatHTML"
                                value="html">
                            <label class="form-check-label" for="formatHTML">
                                HTML Report
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="downloadFormat" id="formatPDF"
                                value="pdf">
                            <label class="form-check-label" for="formatPDF">
                                PDF Report
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="downloadFormat" id="formatJSON"
                                value="json">
                            <label class="form-check-label" for="formatJSON">
                                JSON Analysis Data
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="analyze-btn" id="startAnalysis">
                <i class="fas fa-play me-2"></i>Start Analysis
            </button>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <h3 class="mb-4">
                <i class="fas fa-spinner fa-spin me-2"></i>Analyzing SQL File
            </h3>

            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar"
                    style="width: 0%"></div>
            </div>

            <div id="progressText" class="text-center text-muted">
                Initializing analysis...
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3 class="mb-4">
                <i class="fas fa-check-circle text-success me-2"></i>An√°lisis Completado
            </h3>

            <div id="analysisResults">
                <!-- Results will be populated here -->
            </div>

            <!-- Post-Analysis Features -->
            <div class="post-analysis-features mt-4" id="postAnalysisFeatures">
                <h4 class="mb-3">
                    <i class="fas fa-tools me-2"></i>Funciones Adicionales
                </h4>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-warning w-100" id="autoFixBtn">
                            <i class="fas fa-magic me-2"></i>Corregir Errores Autom√°ticamente
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-info w-100" id="addCommentsBtn">
                            <i class="fas fa-comment-alt me-2"></i>Agregar Comentarios
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-success w-100" id="generateDataBtn">
                            <i class="fas fa-database me-2"></i>Generar Datos de Prueba
                        </button>
                    </div>
                </div>

                <!-- Sample Data Configuration -->
                <div class="sample-data-config mt-3" id="sampleDataConfig" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Configuraci√≥n de Datos de Prueba</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="recordsSlider" class="form-label">
                                        Registros por tabla: <span id="recordsValue">100</span>
                                    </label>
                                    <input type="range" class="form-range" id="recordsSlider" min="10" max="10000"
                                        value="100" step="10">
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="realisticData" checked>
                                        <label class="form-check-label" for="realisticData">
                                            Usar datos realistas
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="referentialIntegrity"
                                            checked>
                                        <label class="form-check-label" for="referentialIntegrity">
                                            Mantener integridad referencial
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3" id="generateSampleData">
                                <i class="fas fa-play me-2"></i>Generar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Results Display -->
            <div class="enhanced-results mt-4" id="enhancedResults" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-code me-2"></i>SQL Mejorado
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="comparison-view" id="comparisonView">
                            <!-- Before/After comparison will be shown here -->
                        </div>
                        <pre id="enhancedSqlContent" class="bg-light p-3 rounded"
                            style="max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button class="download-btn" id="downloadResults">
                    <i class="fas fa-download me-2"></i>Descargar Resultados
                </button>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Analizar Otro Archivo
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core JavaScript Modules -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/session-manager.js"></script>
    <script src="/static/js/websocket-manager.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/upload.js"></script>
    <script src="/static/js/analysis.js"></script>

    <script>
        // Simple analysis page controller
        class SimpleAnalyzer {
            constructor() {
                this.currentFile = null;
                this.analysisId = null;
                this.init();
            }

            init() {
                this.setupFileUpload();
                this.setupAnalysis();
                if (window.Utils) Utils.log('üî¨ Analysis page initialized');
            }

            setupFileUpload() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');
                const analysisOptions = document.getElementById('analysisOptions');

                // Click to upload
                uploadArea.addEventListener('click', () => fileInput.click());

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            }

            handleFile(file) {
                this.currentFile = file;

                // Show file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('analysisOptions').style.display = 'block';

                if (window.Utils) Utils.log('File selected:', file.name);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            setupAnalysis() {
                document.getElementById('startAnalysis').addEventListener('click', () => {
                    this.startAnalysis();
                });

                // Setup post-analysis features
                this.setupPostAnalysisFeatures();
            }

            setupPostAnalysisFeatures() {
                // Auto-fix errors button
                document.getElementById('autoFixBtn').addEventListener('click', () => {
                    this.autoFixErrors();
                });

                // Add comments button
                document.getElementById('addCommentsBtn').addEventListener('click', () => {
                    this.addComments();
                });

                // Generate sample data button
                document.getElementById('generateDataBtn').addEventListener('click', () => {
                    this.toggleSampleDataConfig();
                });

                // Generate sample data with config
                document.getElementById('generateSampleData').addEventListener('click', () => {
                    this.generateSampleData();
                });

                // Records slider
                const recordsSlider = document.getElementById('recordsSlider');
                const recordsValue = document.getElementById('recordsValue');
                recordsSlider.addEventListener('input', (e) => {
                    recordsValue.textContent = e.target.value;
                });
            }

            async startAnalysis() {
                if (!this.currentFile) return;

                // Show progress section
                document.getElementById('analysisOptions').style.display = 'none';
                document.getElementById('progressSection').style.display = 'block';

                try {
                    // Start real analysis
                    await this.performRealAnalysis();

                } catch (error) {
                    if (window.Utils) Utils.error('Analysis failed:', error);
                    alert('Analysis failed: ' + error.message);
                    // Reset to options view
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('analysisOptions').style.display = 'block';
                }
            }

            async performRealAnalysis() {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                // Update progress
                progressBar.style.width = '10%';
                progressText.textContent = 'Uploading file...';

                // Create form data
                const formData = new FormData();
                formData.append('file', this.currentFile);

                try {
                    // Update progress
                    progressBar.style.width = '30%';
                    progressText.textContent = 'Analyzing SQL...';

                    // Call the API
                    const response = await fetch('/api/analyze/simple', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Analysis failed: ${response.statusText}`);
                    }

                    // Update progress
                    progressBar.style.width = '80%';
                    progressText.textContent = 'Processing results...';

                    const result = await response.json();

                    // Update progress
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Analysis complete!';

                    // Store results and show them
                    this.analysisResult = result;
                    await new Promise(resolve => setTimeout(resolve, 500));
                    this.showRealResults();

                } catch (error) {
                    throw error;
                }
            }

            showRealResults() {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';

                const result = this.analysisResult;

                // Display real results
                const results = `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">${result.errors_found}</h4>
                                <small class="text-muted">Errors Found</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">${result.comments_added}</h4>
                                <small class="text-muted">Comments Added</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">${result.optimizations}</h4>
                                <small class="text-muted">Optimizations</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">${result.quality_score}%</h4>
                                <small class="text-muted">Quality Score</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>File Information</h5>
                            <ul class="list-unstyled">
                                <li><strong>Filename:</strong> ${result.filename}</li>
                                <li><strong>Size:</strong> ${this.formatFileSize(result.size)}</li>
                                <li><strong>Lines:</strong> ${result.lines}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>SQL Analysis</h5>
                            <ul class="list-unstyled">
                                <li><strong>Total Statements:</strong> ${result.analysis_summary.total_statements}</li>
                                <li><strong>CREATE Statements:</strong> ${result.analysis_summary.create_statements}</li>
                                <li><strong>SELECT Statements:</strong> ${result.analysis_summary.select_statements}</li>
                                <li><strong>INSERT Statements:</strong> ${result.analysis_summary.insert_statements}</li>
                            </ul>
                        </div>
                    </div>
                `;

                document.getElementById('analysisResults').innerHTML = results;

                // Setup download
                document.getElementById('downloadResults').addEventListener('click', () => {
                    this.downloadRealResults();
                });
            }

            downloadRealResults() {
                const format = document.querySelector('input[name="downloadFormat"]:checked').value;
                const fileName = this.currentFile.name.replace(/\.[^/.]+$/, '') + '_analyzed.' + format;

                let content = '';
                let mimeType = 'text/plain';

                if (format === 'sql') {
                    content = this.analysisResult.processed_content;
                    mimeType = 'text/plain';
                } else if (format === 'json') {
                    content = JSON.stringify(this.analysisResult, null, 2);
                    mimeType = 'application/json';
                } else if (format === 'html') {
                    content = this.generateHTMLReport();
                    mimeType = 'text/html';
                } else {
                    content = this.generateTextReport();
                    mimeType = 'text/plain';
                }

                // Create download
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const element = document.createElement('a');
                element.setAttribute('href', url);
                element.setAttribute('download', fileName);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                URL.revokeObjectURL(url);

                if (window.Utils) Utils.log('Download started:', fileName);
            }

            generateHTMLReport() {
                const result = this.analysisResult;
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>SQL Analysis Report - ${result.filename}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { background: #f8f9fa; padding: 20px; border-radius: 5px; }
                            .stats { display: flex; gap: 20px; margin: 20px 0; }
                            .stat { text-align: center; padding: 10px; background: #e9ecef; border-radius: 5px; }
                            pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>SQL Analysis Report</h1>
                            <p><strong>File:</strong> ${result.filename}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                        </div>

                        <div class="stats">
                            <div class="stat">
                                <h3>${result.errors_found}</h3>
                                <p>Errors Found</p>
                            </div>
                            <div class="stat">
                                <h3>${result.quality_score}%</h3>
                                <p>Quality Score</p>
                            </div>
                            <div class="stat">
                                <h3>${result.analysis_summary.total_statements}</h3>
                                <p>SQL Statements</p>
                            </div>
                        </div>

                        <h2>Processed SQL Content</h2>
                        <pre>${result.processed_content}</pre>
                    </body>
                    </html>
                `;
            }

            generateTextReport() {
                const result = this.analysisResult;
                return `SQL ANALYSIS REPORT
===================

File: ${result.filename}
Size: ${this.formatFileSize(result.size)}
Lines: ${result.lines}
Generated: ${new Date().toLocaleString()}

ANALYSIS SUMMARY
================
Errors Found: ${result.errors_found}
Comments Added: ${result.comments_added}
Optimizations: ${result.optimizations}
Quality Score: ${result.quality_score}%

SQL STATEMENTS
==============
Total Statements: ${result.analysis_summary.total_statements}
CREATE Statements: ${result.analysis_summary.create_statements}
SELECT Statements: ${result.analysis_summary.select_statements}
INSERT Statements: ${result.analysis_summary.insert_statements}
UPDATE Statements: ${result.analysis_summary.update_statements}
DELETE Statements: ${result.analysis_summary.delete_statements}

PROCESSED CONTENT
=================
${result.processed_content}
`;
            }

            // Post-Analysis Feature Methods
            async autoFixErrors() {
                if (!this.currentFile) return;

                try {
                    const button = document.getElementById('autoFixBtn');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Corrigiendo...';
                    button.disabled = true;

                    // Call auto-fix API
                    const formData = new FormData();
                    formData.append('file', this.currentFile);

                    const response = await fetch('/api/auto-fix', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Error en la correcci√≥n autom√°tica');
                    }

                    const result = await response.json();

                    // Show enhanced results
                    this.showEnhancedResults(result, 'auto-fix');

                } catch (error) {
                    alert('Error al corregir errores: ' + error.message);
                } finally {
                    const button = document.getElementById('autoFixBtn');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            async addComments() {
                if (!this.currentFile) return;

                try {
                    const button = document.getElementById('addCommentsBtn');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Agregando comentarios...';
                    button.disabled = true;

                    // Call add comments API
                    const formData = new FormData();
                    formData.append('file', this.currentFile);

                    const response = await fetch('/api/add-comments', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Error al agregar comentarios');
                    }

                    const result = await response.json();

                    // Show enhanced results
                    this.showEnhancedResults(result, 'comments');

                } catch (error) {
                    alert('Error al agregar comentarios: ' + error.message);
                } finally {
                    const button = document.getElementById('addCommentsBtn');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            toggleSampleDataConfig() {
                const config = document.getElementById('sampleDataConfig');
                if (config.style.display === 'none') {
                    config.style.display = 'block';
                } else {
                    config.style.display = 'none';
                }
            }

            async generateSampleData() {
                if (!this.currentFile) return;

                try {
                    const button = document.getElementById('generateSampleData');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
                    button.disabled = true;

                    // Get configuration
                    const recordsPerTable = document.getElementById('recordsSlider').value;
                    const useRealisticData = document.getElementById('realisticData').checked;
                    const maintainIntegrity = document.getElementById('referentialIntegrity').checked;

                    // Call generate sample data API
                    const formData = new FormData();
                    formData.append('file', this.currentFile);
                    formData.append('records_per_table', recordsPerTable);
                    formData.append('realistic_data', useRealisticData);
                    formData.append('referential_integrity', maintainIntegrity);

                    const response = await fetch('/api/generate-sample-data', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Error al generar datos de prueba');
                    }

                    const result = await response.json();

                    // Show enhanced results
                    this.showEnhancedResults(result, 'sample-data');

                    // Hide configuration
                    document.getElementById('sampleDataConfig').style.display = 'none';

                } catch (error) {
                    alert('Error al generar datos de prueba: ' + error.message);
                } finally {
                    const button = document.getElementById('generateSampleData');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            showEnhancedResults(result, type) {
                const enhancedResults = document.getElementById('enhancedResults');
                const sqlContent = document.getElementById('enhancedSqlContent');
                const comparisonView = document.getElementById('comparisonView');

                enhancedResults.style.display = 'block';

                if (type === 'auto-fix') {
                    sqlContent.textContent = result.corrected_sql || result.enhanced_sql;

                    // Show corrections summary
                    if (result.corrections && result.corrections.length > 0) {
                        comparisonView.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check me-2"></i>Correcciones Aplicadas (${result.corrections.length})</h6>
                                <ul class="mb-0">
                                    ${result.corrections.map(correction =>
                            `<li>L√≠nea ${correction.line_number}: ${correction.fixes.map(fix => fix.description).join(', ')}</li>`
                        ).join('')}
                                </ul>
                            </div>
                        `;
                    }

                } else if (type === 'comments') {
                    sqlContent.textContent = result.commented_sql || result.enhanced_sql;

                    // Show comments summary
                    if (result.comments_added > 0) {
                        comparisonView.innerHTML = `
                            <div class="alert alert-info">
                                <h6><i class="fas fa-comment me-2"></i>Comentarios Agregados: ${result.comments_added}</h6>
                                <p class="mb-0">Se han a√±adido comentarios explicativos en espa√±ol para mejorar la comprensi√≥n del c√≥digo SQL.</p>
                            </div>
                        `;
                    }

                } else if (type === 'sample-data') {
                    sqlContent.textContent = result.insert_statements || result.enhanced_sql;

                    // Show generation summary
                    comparisonView.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-database me-2"></i>Datos de Prueba Generados</h6>
                            <ul class="mb-0">
                                <li>Tablas procesadas: ${result.tables_processed || 0}</li>
                                <li>Registros totales: ${result.total_records || 0}</li>
                                <li>Registros por tabla: ${result.generation_config?.records_per_table || 'N/A'}</li>
                            </ul>
                        </div>
                    `;
                }

                // Update the current analysis result for download
                this.enhancedResult = result;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleAnalyzer();
        });
    </script>
</body>

</html>